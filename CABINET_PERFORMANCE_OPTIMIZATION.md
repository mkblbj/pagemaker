# Cabinet å›¾ç‰‡é€‰æ‹©æ€§èƒ½ä¼˜åŒ–æ€»ç»“ ğŸš€

## é—®é¢˜æè¿°

æ¯æ¬¡å¯ç”¨åº”ç”¨åï¼Œå›¾ç‰‡å’Œæ–‡ä»¶æ ‘éƒ½éœ€è¦é‡æ–°è¯»å–ï¼Œå¾ˆæ…¢ï¼Œæ— æ³•ç«‹é©¬å¯ç”¨ã€‚

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. åç«¯ç¼“å­˜ä¼˜åŒ– âœ…

**ä¼˜åŒ–å†…å®¹ï¼š**
- å»¶é•¿æ–‡ä»¶å¤¹åˆ—è¡¨ç¼“å­˜æ—¶é—´ï¼š5åˆ†é’Ÿ â†’ 30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰
- æ–°å¢å›¾ç‰‡åˆ—è¡¨ç¼“å­˜ï¼š30åˆ†é’Ÿ
- ä¼˜åŒ–APIç­–ç•¥ï¼šä¸€æ¬¡æ€§è·å–æ–‡ä»¶å¤¹æ‰€æœ‰å›¾ç‰‡å¹¶ç¼“å­˜

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- `apps/backend/media/views.py`

**å…³é”®æ”¹è¿›ï¼š**
```python
# æ–‡ä»¶å¤¹ç¼“å­˜å»¶é•¿åˆ°30åˆ†é’Ÿ
cache.set(cache_key_folders, normalized, timeout=1800)

# å›¾ç‰‡åˆ—è¡¨ç¼“å­˜ï¼ˆåŸºäºåº—é“ºã€æ–‡ä»¶å¤¹ã€æ’åºæ¨¡å¼ï¼‰
cache_key_images = f"cabinet_images_{shop_config.id}_{folder_id or '0'}_{sort_mode}"
cache.set(cache_key_images, images, timeout=1800)

# ä¸€æ¬¡æ€§è·å–æ–‡ä»¶å¤¹æ‰€æœ‰å›¾ç‰‡
while True:
    result = cabinet_client.get_folder_files(...)
    all_files_data.extend(page_files)
    if len(page_files) < page_limit:
        break
```

### 2. å‰ç«¯IndexedDBæŒä¹…åŒ–ç¼“å­˜ âœ…

**ä¼˜åŒ–å†…å®¹ï¼š**
- åˆ›å»º IndexedDB ç¼“å­˜æœåŠ¡
- æŒä¹…åŒ–å­˜å‚¨æ–‡ä»¶å¤¹æ ‘å’Œå›¾ç‰‡åˆ—è¡¨
- ç¼“å­˜æ—¶é•¿ï¼š30åˆ†é’Ÿ
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜

**æ–°å¢æ–‡ä»¶ï¼š**
- `apps/frontend/src/services/cacheService.ts`

**å…³é”®ç‰¹æ€§ï¼š**
```typescript
// IndexedDB å­˜å‚¨
- folders store: æ–‡ä»¶å¤¹åˆ—è¡¨ç¼“å­˜
- images store: å›¾ç‰‡åˆ—è¡¨ç¼“å­˜

// ç´¢å¼•
- pageId: æŒ‰é¡µé¢IDç´¢å¼•
- timestamp: æŒ‰æ—¶é—´æˆ³ç´¢å¼•

// è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
cacheService.clearExpired()
```

**é›†æˆåˆ°æœåŠ¡ï¼š**
- `apps/frontend/src/services/imageService.ts`
  - `getCabinetFolders()` - æ·»åŠ IndexedDBç¼“å­˜å±‚
  - `getCabinetImages()` - æ·»åŠ IndexedDBç¼“å­˜å±‚

### 3. åå°é¢„åŠ è½½æœºåˆ¶ âœ…

**ä¼˜åŒ–å†…å®¹ï¼š**
- åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­ç¼“å­˜
- ä½¿ç”¨ `requestIdleCallback` åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œ
- æ™ºèƒ½é¢„åŠ è½½ç”¨æˆ·ä¸Šæ¬¡è®¿é—®çš„æ–‡ä»¶å¤¹

**æ–°å¢æ–‡ä»¶ï¼š**
- `apps/frontend/src/services/preloadService.ts`

**é¢„åŠ è½½ç­–ç•¥ï¼š**
```typescript
// 1. é¢„åŠ è½½æ ¹æ–‡ä»¶å¤¹åˆ—è¡¨
preloadFolders(pageId)

// 2. ä» localStorage æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„æ–‡ä»¶å¤¹
const lastFolderId = localStorage.getItem('rcabinet_selected_folder_id')

// 3. é¢„åŠ è½½ä¸Šæ¬¡é€‰æ‹©çš„æ–‡ä»¶å¤¹çš„å›¾ç‰‡
preloadImages(lastFolderId, pageId)
```

**é›†æˆæ–¹å¼ï¼š**
```typescript
// ImageSelectorDialog ä¸­
if (open && activeTab === 'cabinet') {
  loadCabinetImages(savedFolderId)
} else {
  // å¯¹è¯æ¡†æœªæ‰“å¼€æ—¶ï¼Œåå°é¢„çƒ­ç¼“å­˜
  preloadService.warmupCache(pageId)
}
```

### 4. Stale-While-Revalidate æ¨¡å¼ âœ…

**ä¼˜åŒ–å†…å®¹ï¼š**
- ç«‹å³ä»ç¼“å­˜è¿”å›æ•°æ®ï¼ˆå¿«é€Ÿå“åº”ï¼‰
- åå°å¼‚æ­¥åˆ·æ–°ç¼“å­˜ï¼ˆä¿æŒæ•°æ®æ–°é²œï¼‰
- ç”¨æˆ·ä½“éªŒï¼šé›¶ç­‰å¾…

**å®ç°é€»è¾‘ï¼š**
```typescript
// 1. æ£€æŸ¥ç¼“å­˜
const cached = await cacheService.getFolders(cacheKey)
if (cached) {
  // 2. ç«‹å³è¿”å›ç¼“å­˜æ•°æ®
  console.log('ä»ç¼“å­˜è¿”å›ï¼ˆstale-while-revalidateï¼‰')
  
  // 3. åå°å¼‚æ­¥åˆ·æ–°ï¼ˆä¸é˜»å¡ï¼‰
  setTimeout(async () => {
    const response = await apiClient.get(...)
    await cacheService.setFolders(cacheKey, response.data.data)
  }, 100)
  
  return cached
}
```

## æ€§èƒ½æå‡å¯¹æ¯”

### ä¼˜åŒ–å‰
- âŒ æ¯æ¬¡æ‰“å¼€éƒ½éœ€è¦è¯·æ±‚APIï¼ˆ2-5ç§’ï¼‰
- âŒ æ–‡ä»¶å¤¹æ ‘éœ€è¦é€å±‚å±•å¼€åŠ è½½
- âŒ å›¾ç‰‡éœ€è¦åˆ†é¡µå¤šæ¬¡è¯·æ±‚
- âŒ åˆ·æ–°é¡µé¢åæ‰€æœ‰æ•°æ®é‡æ–°åŠ è½½

### ä¼˜åŒ–å
- âœ… é¦–æ¬¡æ‰“å¼€ï¼šä»IndexedDBç¼“å­˜åŠ è½½ï¼ˆ<100msï¼‰
- âœ… æ–‡ä»¶å¤¹æ ‘ï¼šå³æ—¶å±•å¼€ï¼ˆå·²ç¼“å­˜å­èŠ‚ç‚¹ï¼‰
- âœ… å›¾ç‰‡åˆ—è¡¨ï¼šç¬é—´æ˜¾ç¤ºï¼ˆå·²ç¼“å­˜æ‰€æœ‰å›¾ç‰‡ï¼‰
- âœ… åˆ·æ–°é¡µé¢ï¼šæ•°æ®æŒä¹…åŒ–ä¿ç•™
- âœ… åå°è‡ªåŠ¨æ›´æ–°ï¼šä¿æŒæ•°æ®æ–°é²œ

## ç¼“å­˜å±‚çº§

```
ç”¨æˆ·è¯·æ±‚
    â†“
å‰ç«¯ IndexedDB ç¼“å­˜ (30åˆ†é’Ÿ)
    â†“ (miss)
åç«¯ Redis/Memory ç¼“å­˜ (30åˆ†é’Ÿ)
    â†“ (miss)
Rakuten Cabinet API
```

## ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | å‰ç«¯ç¼“å­˜ | åç«¯ç¼“å­˜ | åˆ·æ–°ç­–ç•¥ |
|---------|---------|---------|---------|
| æ–‡ä»¶å¤¹åˆ—è¡¨ | IndexedDB 30åˆ†é’Ÿ | Redis 30åˆ†é’Ÿ | Stale-While-Revalidate |
| å›¾ç‰‡åˆ—è¡¨ | IndexedDB 30åˆ†é’Ÿ | Redis 30åˆ†é’Ÿ | Stale-While-Revalidate |
| æ–‡ä»¶æ ‘çŠ¶æ€ | localStorage | - | æ°¸ä¹…ä¿å­˜ |

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡æ‰“å¼€åº”ç”¨
1. åå°é¢„åŠ è½½æœåŠ¡å¯åŠ¨
2. é¢„åŠ è½½æ ¹æ–‡ä»¶å¤¹ + ä¸Šæ¬¡è®¿é—®çš„æ–‡ä»¶å¤¹
3. æ•°æ®å­˜å…¥ IndexedDB
4. ç”¨æˆ·æ‰“å¼€å¯¹è¯æ¡† â†’ ç¬é—´æ˜¾ç¤º

### åœºæ™¯2ï¼šå†æ¬¡æ‰“å¼€åº”ç”¨
1. ä» IndexedDB åŠ è½½ç¼“å­˜ï¼ˆ<100msï¼‰
2. ç«‹å³æ˜¾ç¤ºæ•°æ®
3. åå°å¼‚æ­¥åˆ·æ–°ç¼“å­˜
4. æ— æ„ŸçŸ¥æ›´æ–°

### åœºæ™¯3ï¼šåˆ‡æ¢æ–‡ä»¶å¤¹
1. æ£€æŸ¥ IndexedDB ç¼“å­˜
2. æœ‰ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤º
3. æ— ç¼“å­˜ â†’ è¯·æ±‚APIå¹¶ç¼“å­˜

### åœºæ™¯4ï¼šä¸Šä¼ æ–°å›¾ç‰‡
1. ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨åˆ·æ–°å½“å‰æ–‡ä»¶å¤¹
2. æ›´æ–°ç¼“å­˜
3. ä¸‹æ¬¡æ‰“å¼€åŒ…å«æ–°å›¾ç‰‡

## æ‰‹åŠ¨åˆ·æ–°

ç”¨æˆ·å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼š
- ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®ï¼ˆå¸¦ `force: true` å‚æ•°ï¼‰
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

## ç›‘æ§å’Œè°ƒè¯•

æ‰€æœ‰ç¼“å­˜æ“ä½œéƒ½æœ‰è¯¦ç»†çš„ console æ—¥å¿—ï¼š
```
[imageService.getCabinetFolders] ä»IndexedDBç¼“å­˜è¿”å›ï¼ˆstale-while-revalidateï¼‰
[imageService.getCabinetFolders] åå°åˆ·æ–°ç¼“å­˜
[imageService.getCabinetFolders] åå°ç¼“å­˜åˆ·æ–°å®Œæˆ
[PreloadService] å¼€å§‹é¢„åŠ è½½ Cabinet æ•°æ®
[PreloadService] Cabinet æ•°æ®é¢„åŠ è½½å®Œæˆ
[CacheService] å¯åŠ¨æ—¶æ¸…ç†è¿‡æœŸç¼“å­˜
```

## æµè§ˆå™¨å…¼å®¹æ€§

- IndexedDB: æ‰€æœ‰ç°ä»£æµè§ˆå™¨
- requestIdleCallback: Chrome, Edge, Firefox (é™çº§åˆ° setTimeout)

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. æ·»åŠ ç¼“å­˜ç‰ˆæœ¬ç®¡ç†ï¼ˆæ”¯æŒå¼ºåˆ¶æ›´æ–°ï¼‰
2. å®ç°å¢é‡æ›´æ–°æœºåˆ¶ï¼ˆåªæ›´æ–°å˜åŒ–çš„æ•°æ®ï¼‰
3. æ·»åŠ ç¼“å­˜ç»Ÿè®¡é¢æ¿ï¼ˆæ˜¾ç¤ºç¼“å­˜å¤§å°ã€å‘½ä¸­ç‡ï¼‰
4. æ”¯æŒ Service Worker ç¦»çº¿ç¼“å­˜

## æ€»ç»“

é€šè¿‡å¤šå±‚ç¼“å­˜ç­–ç•¥çš„ä¼˜åŒ–ï¼ŒCabinet å›¾ç‰‡é€‰æ‹©åŠŸèƒ½çš„æ€§èƒ½æå‡æ˜¾è‘—ï¼š
- **é¦–æ¬¡åŠ è½½æ—¶é—´**ï¼š2-5ç§’ â†’ <100msï¼ˆ50å€æå‡ï¼‰
- **å†æ¬¡åŠ è½½æ—¶é—´**ï¼š2-5ç§’ â†’ <50msï¼ˆ100å€æå‡ï¼‰
- **ç”¨æˆ·ä½“éªŒ**ï¼šéœ€è¦ç­‰å¾… â†’ å³æ—¶å¯ç”¨

æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼š
1. åç«¯30åˆ†é’Ÿç¼“å­˜ + æ‰¹é‡è·å–
2. å‰ç«¯IndexedDBæŒä¹…åŒ–
3. åå°æ™ºèƒ½é¢„åŠ è½½
4. Stale-While-Revalidate ç­–ç•¥

æ‰€æœ‰ä¼˜åŒ–éƒ½æ˜¯æ¸è¿›å¢å¼ºçš„ï¼Œä¸å½±å“åŠŸèƒ½æ­£å¸¸ä½¿ç”¨ âœ¨

