# Story 2.6: 店铺API与FTP凭据配置管理

## Status: Draft

## Story

**As a** 管理员(administrator),
**I want** 有一个"店铺配置"页面，可以在其中为每个店铺安全地输入、保存和管理乐天API的serviceSecret、licenseKey以及FTP的连接凭据,
**so that** Pagemaker系统能够成功与乐天服务进行认证和数据交换，从而启用图片上传等核心功能。

l,k.;## Acceptance Criteria

1. 在CMS主导航区域，应有一个仅对admin角色用户可见的"店铺配置"入口。
2. 配置页面以列表形式展示所有已创建的店铺配置，列表项应显示店铺名称和目标区域。
3. 页面提供"新增配置"功能，点击后弹出表单。
4. 表单中包含所有必要字段：店铺名称、目标区域、API Service Secret、API License Key、FTP主机、FTP端口、FTP用户和FTP密码。
5. 所有密钥和密码输入框在输入时必须以密文（●●●●●●）形式显示，以防旁人窥视。
6. 提交保存后，凭据信息通过API安全地发送到后端进行加密存储。
7. 在编辑一个已存在的配置时，页面应能显示其"API密钥到期日"，并提供一个"刷新"按钮来触发调用 POST /api/v1/shop-configurations/{id}/refresh-expiry 接口，以更新此日期。
8. 任何保存或更新操作后，界面都应提供清晰的成功或失败提示。

## Tasks / Subtasks

- [ ] 创建后端ShopConfiguration模型和API (AC: 6, 7)
  - [ ] 在 `apps/backend/pagemaker/configurations/models.py` 创建 ShopConfiguration 模型
  - [ ] 实现字段加密存储机制（api_service_secret, api_license_key, ftp_password）
  - [ ] 创建 `configurations/serializers.py` 实现序列化器
  - [ ] 创建 `configurations/repositories.py` 实现仓库模式
  - [ ] 在 `configurations/views.py` 创建CRUD视图和refresh-expiry端点
  - [ ] 配置 `configurations/urls.py` 路由
  - [ ] 实现 IsAdminOnly 权限类
- [ ] 创建前端店铺配置页面组件 (AC: 1, 2)
  - [ ] 在 `app/(protected)/shop-configurations/` 创建页面路由
  - [ ] 创建 `ShopConfigurationList` 组件显示配置列表
  - [ ] 实现角色检查，仅对admin用户显示导航入口
  - [ ] 配置受保护路由布局
- [ ] 实现配置表单功能 (AC: 3, 4, 5)
  - [ ] 创建 `ShopConfigurationForm` 组件
  - [ ] 实现密码字段的密文显示功能
  - [ ] 添加表单验证（必填字段、端口号格式等）
  - [ ] 实现表单提交和错误处理
- [ ] 实现编辑和刷新功能 (AC: 7, 8)
  - [ ] 在列表中添加编辑按钮
  - [ ] 实现编辑模式下的表单预填充
  - [ ] 显示API密钥到期日期
  - [ ] 实现刷新按钮调用refresh-expiry接口
  - [ ] 添加成功/失败提示组件
- [ ] 创建API服务层 (AC: 6, 7)
  - [ ] 在 `src/services/shopConfigurationService.ts` 创建API服务函数
  - [ ] 实现 getShopConfigurations, createShopConfiguration, updateShopConfiguration 函数
  - [ ] 实现 refreshApiExpiry 函数
  - [ ] 配置SWR数据获取和缓存
- [ ] 实现安全性和用户体验 (AC: 5, 8)
  - [ ] 确保敏感数据在传输中加密
  - [ ] 实现用户友好的错误消息
  - [ ] 添加加载状态指示器
  - [ ] 实现表单数据验证和清理
- [ ] 添加单元测试和集成测试
  - [ ] 为 ShopConfiguration 模型编写后端测试
  - [ ] 为 configurations API 视图编写测试
  - [ ] 为前端组件编写单元测试
  - [ ] 为API服务函数编写测试
  - [ ] 编写端到端测试验证完整流程

## Dev Notes

### Previous Story Insights
从之前的故事中获得的关键经验：
- 遵循仓库模式进行数据访问，避免在视图中直接使用Django ORM
- 使用受保护路由布局确保只有认证用户可以访问
- 前端组件应该通过服务层调用API，不直接使用axios或fetch
- 使用SWR进行数据获取和缓存管理

### Data Models
基于架构文档中的ShopConfiguration模型定义 [Source: architecture/data-models.md#模型-3-shopconfiguration-店铺配置]:

**ShopConfiguration模型字段:**
- `id`: UUID - 唯一标识符 (主键)
- `shop_name`: String - 用户可识别的店铺名称
- `target_area`: String (Unique) - 关联到PageTemplate的target_area字段
- `api_service_secret`: EncryptedString - 加密存储的乐天API Service Secret
- `api_license_key`: EncryptedString - 加密存储的乐天API License Key
- `api_license_expiry_date`: DateTime (Nullable) - API许可证密钥到期日期
- `ftp_host`: String - FTP服务器地址
- `ftp_port`: Integer - FTP服务器端口 (默认21)
- `ftp_user`: String - FTP用户名
- `ftp_password`: EncryptedString - 加密存储的FTP密码
- `created_at`, `updated_at`: DateTime - 时间戳

**TypeScript接口 (packages/shared-types):**
```typescript
interface ShopConfiguration {
  id: string;
  shopName: string;
  targetArea: string;
  apiLicenseExpiryDate?: string | null; // ISO 8601 Date String
}
```

### API Specifications
基于REST API规范 [Source: architecture/rest-api-spec.md]:

**主要端点:**
- `GET /api/v1/shop-configurations/` - 获取配置列表
- `POST /api/v1/shop-configurations/` - 创建新配置
- `PUT /api/v1/shop-configurations/{id}/` - 更新配置
- `DELETE /api/v1/shop-configurations/{id}/` - 删除配置
- `POST /api/v1/shop-configurations/{id}/refresh-expiry` - 刷新API密钥到期日

**认证要求:** 所有端点需要JWT Bearer token认证

### Component Specifications
基于前端架构指导 [Source: architecture/frontend-architecture.md]:

**主要组件:**
- `ShopConfigurationList` - 配置列表显示组件
- `ShopConfigurationForm` - 配置表单组件（新增/编辑）
- `PasswordField` - 支持密文显示的密码输入组件

**状态管理:** 使用SWR进行数据获取和缓存，无需额外的Zustand store

**路由结构:**
```
app/(protected)/shop-configurations/
├── page.tsx                    # 配置列表页面
├── new/
│   └── page.tsx               # 新增配置页面
└── [id]/
    └── edit/
        └── page.tsx           # 编辑配置页面
```

### File Locations
基于统一项目结构 [Source: architecture/unified-project-structure.md]:

**后端文件位置:**
- `apps/backend/pagemaker/configurations/models.py` - ShopConfiguration模型
- `apps/backend/pagemaker/configurations/views.py` - API视图
- `apps/backend/pagemaker/configurations/serializers.py` - 序列化器
- `apps/backend/pagemaker/configurations/repositories.py` - 仓库类
- `apps/backend/pagemaker/configurations/permissions.py` - 权限类
- `apps/backend/pagemaker/configurations/urls.py` - URL路由

**前端文件位置:**
- `apps/frontend/app/(protected)/shop-configurations/` - 页面组件
- `apps/frontend/src/components/shop-configuration/` - 相关UI组件
- `apps/frontend/src/services/shopConfigurationService.ts` - API服务层

### Testing Requirements
基于测试策略 [Source: architecture/testing-strategy.md]:

**后端测试 (Pytest):**
- 测试文件位置: `apps/backend/pagemaker/configurations/tests/`
- 需要测试模型的加密/解密功能
- 需要测试权限控制（只有admin可以访问）
- 需要测试refresh-expiry端点的功能

**前端测试 (Vitest):**
- 测试文件与组件并置存放 (`.test.tsx`)
- 需要Mock API调用和认证状态
- 需要测试密码字段的密文显示功能
- 需要测试表单验证和错误处理

### Technical Constraints
**安全要求:**
- 敏感字段必须在数据库中加密存储
- 密码字段在UI中必须以密文显示
- API传输必须使用HTTPS
- 只有admin角色用户可以访问此功能

**性能考虑:**
- 配置数据量较小，无需特殊的分页处理
- 使用SWR缓存减少不必要的API调用

**Django配置:**
- 需要在settings.py中配置字段加密的密钥
- 确保configurations app在INSTALLED_APPS中注册

### Testing

**测试文件位置:**
- 后端: `apps/backend/pagemaker/configurations/tests/` 目录
- 前端: 与组件文件并置的 `.test.tsx` 文件

**测试框架:**
- 后端: Pytest，使用现有开发数据库
- 前端: Vitest + React Testing Library

**关键测试用例:**
- 模型字段加密/解密功能测试
- API权限控制测试（仅admin可访问）
- 表单验证和错误处理测试
- 密码字段密文显示测试
- refresh-expiry端点功能测试

**测试运行:**
- 后端: `cd apps/backend && make test`
- 前端: `cd apps/frontend && pnpm test`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-28 | 1.0 | Initial story creation | SM Agent (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*
