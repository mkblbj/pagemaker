# Story 1.8: 两列式键值对/表格模块集成与配置

## Status: approved

## Story

**As a** 运营专员,
**I want** 能够在Pagemaker编辑器中使用"两列式键值对/表格模块"，并能输入/管理键值对行、设置标签列背景色和文本颜色,
**so that** 在页面中清晰地展示商品属性等信息。

## Acceptance Criteria

1. 用户能将"两列式键值对/表格模块"添加到画布上。
2. 用户能在属性面板中输入多组成对的"标签/键"和"内容/值"。
3. 用户能方便地增加或删除键值对行。
4. 用户能在属性面板中为文本选择颜色，并为标签列设置背景色。
5. 导出的HTML能正确反映所有配置。
6. 编辑器中的预览能实时更新。
7. 选中模块后，用户可以在属性面板中方便地输入和管理键值对行，这些数据将作为页面内容JSON结构的一部分，通过`PUT /api/v1/pages/{id}/ `接口进行统一保存。

## Tasks / Subtasks

- [ ] Task 1: 创建键值对模块组件基础结构 (AC: 1)
  - [ ] 在 `apps/frontend/src/components/modules/` 创建 `KeyValueModule.tsx`
  - [ ] 定义 `KeyValueModuleConfig` 接口在 `packages/shared-types`
  - [ ] 添加 'keyValue' 类型到 `PageModule` 联合类型
  - [ ] 在模块注册表中注册键值对模块

- [ ] Task 2: 实现键值对模块属性面板 (AC: 2, 3, 4)
  - [ ] 创建 `KeyValuePropertiesPanel.tsx` 组件
  - [ ] 实现键值对行的动态增加和删除功能
  - [ ] 实现标签/键和内容/值的输入字段
  - [ ] 实现文本颜色选择器
  - [ ] 实现标签列背景色选择器
  - [ ] 集成到主属性面板路由中

- [ ] Task 3: 实现键值对模块渲染逻辑 (AC: 6)
  - [ ] 实现表格形式的键值对渲染
  - [ ] 支持动态行数的表格布局
  - [ ] 应用用户配置的颜色和背景色
  - [ ] 实现编辑器中的实时预览更新

- [ ] Task 4: 实现HTML导出功能 (AC: 5)
  - [ ] 在HTML导出服务中添加键值对模块处理逻辑
  - [ ] 确保导出的HTML表格结构正确
  - [ ] 正确应用颜色和背景色样式
  - [ ] 验证导出的HTML在目标环境中正确显示

- [ ] Task 5: 数据持久化集成 (AC: 7)
  - [ ] 确保键值对数据正确序列化到页面内容JSON
  - [ ] 验证通过 `PUT /api/v1/pages/{id}/` 接口的数据保存
  - [ ] 实现页面加载时的键值对数据恢复

- [ ] Task 6: 集成测试和验证 (AC: 1-7)
  - [ ] 编写键值对模块组件的单元测试
  - [ ] 编写属性面板的单元测试
  - [ ] 测试键值对的增加、删除和编辑功能
  - [ ] 测试颜色配置功能
  - [ ] 验证HTML导出结果

## Dev Notes

### Previous Story Insights
从故事 1.7 (分隔模块) 的实现中学到的关键经验：
- 模块组件应遵循单一职责原则，清晰分离关注点
- 使用共享类型定义确保前后端数据一致性
- 属性面板组件应提供直观的用户交互
- HTML导出需要支持标准版和移动端乐天约束版本
- 完整的测试覆盖包括组件渲染、用户交互和边界情况

### Data Models
基于 `packages/shared-types` 中的定义：
- `PageModule` 接口需要扩展以支持 'keyValue' 类型 [Source: architecture/data-models.md#模型1]
- `KeyValueModuleConfig` 接口应包含：
  - `rows: Array<{key: string, value: string}>` - 键值对数据
  - `labelBackgroundColor?: string` - 标签列背景色
  - `textColor?: string` - 文本颜色
- 数据将存储在 `PageTemplate.content` JSON字段中 [Source: architecture/data-models.md#模型1]

### Component Specifications
基于前端架构规范：
- 组件位置：`apps/frontend/src/components/modules/KeyValueModule.tsx` [Source: architecture/unified-project-structure.md]
- 属性面板位置：`apps/frontend/src/components/editor/properties/KeyValuePropertiesPanel.tsx`
- 使用 Zustand store 进行状态管理 [Source: architecture/frontend-architecture.md#状态管理架构]
- 集成 SWR 和 Axios 进行API调用 [Source: architecture/frontend-architecture.md#API集成架构]

### API Specifications
页面保存通过现有API端点：
- `PUT /api/v1/pages/{id}/` - 更新页面内容，包括键值对模块配置 [Source: architecture/rest-api-spec.md]
- 请求体包含完整的 `PageTemplateContent` 结构
- 需要 Bearer Token 认证

### File Locations
遵循统一项目结构：
- 主组件：`apps/frontend/src/components/modules/KeyValueModule.tsx`
- 属性面板：`apps/frontend/src/components/editor/properties/KeyValuePropertiesPanel.tsx`
- 类型定义：`packages/shared-types/src/types/page.ts`
- HTML导出：`apps/frontend/src/services/htmlExportService.ts`
- 模块注册：`apps/frontend/src/lib/moduleRegistry.ts`
- 测试文件：与组件文件并置存放 [Source: architecture/unified-project-structure.md]

### Technical Constraints
基于技术栈和编码规范：
- 使用 TypeScript 5.x 严格模式 [Source: architecture/tech-stack.md]
- 遵循 camelCase/PascalCase 命名约定 [Source: architecture/coding-standards.md#核心规范]
- 必须使用共享类型定义，禁止重复定义 [Source: architecture/coding-standards.md#关键编码规则]
- 使用 Tailwind CSS 4.1 进行样式设计 [Source: architecture/tech-stack.md]
- 集成多语言支持使用 `useTranslation` Hook

### Testing
基于测试策略要求：
- 测试框架：Vitest + React Testing Library [Source: architecture/testing-strategy.md#测试组织]
- 测试文件位置：与组件文件并置 (`.test.tsx`) [Source: architecture/testing-strategy.md#测试组织]
- 测试范围：单元测试覆盖组件渲染、用户交互、配置选项
- 外部依赖必须被模拟 (Mock) [Source: architecture/frontend-architecture.md#前端测试要求]
- 目标覆盖率：组件覆盖率 ≥ 80%，关键业务逻辑 ≥ 90% [Source: architecture/testing-strategy.md#测试覆盖率目标]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent --> 