# Story 0.9: R-Cabinet集成MVP版本

## Status: APPROVED

## Story

- As a 页面编辑器用户
- I want 上传图片文件到R-Cabinet并获得良好的用户体验
- so that 我可以在页面制作中使用这些图片，同时遇到问题时知道如何解决

## MVP Scope Definition

**核心价值**: 用户能够成功上传单张图片并获得可用的文件URL，遇到问题时有清晰的指导
**包含子故事**: 
- Story 0.9.1-MVP: 最小可用文件上传功能
- Story 0.9.2-MVP: 基础错误处理和用户反馈

**不包含**: 批量上传、高级监控、复杂降级策略、性能优化、高级安全扫描

## Acceptance Criteria (ACs)

1. 用户可以上传单个图片文件（JPG/PNG/GIF，最大2MB，最大尺寸3840x3840px）
2. 上传成功后获得可用的文件URL
3. 上传失败时获得清晰的中文错误提示和解决建议
4. 网络错误时自动重试最多3次
5. 不影响现有页面编辑器功能
6. 具备基础的功能开关控制

## Dependencies

**前置条件**:
- ✅ Story 0.8已完成：R-Cabinet API基础连接和认证机制可用
- ✅ 现有页面编辑器功能正常运行
- ✅ shadcn/ui组件库可用于UI开发

**子故事依赖关系**:
- Story 0.9.1-MVP (基础上传功能) → Story 0.9.2-MVP (错误处理)

## Tasks / Subtasks

### 来自Story 0.9.1-MVP的任务
- [ ] Task 1: 实现基础R-Cabinet上传功能 (AC: 1,2)
  - [ ] Subtask 1.1: 基于Story 0.8代码，实现文件上传API调用
  - [ ] Subtask 1.2: 创建简单的后端上传端点 `/api/v1/media/upload-image/`
  - [ ] Subtask 1.3: 实现基础错误处理（网络错误、认证错误、文件错误）
  - [ ] Subtask 1.4: 返回上传结果（成功URL或错误消息）

- [ ] Task 2: 创建简单的前端上传界面 (AC: 1)
  - [ ] Subtask 2.1: 创建文件选择组件（拖拽区域 + 点击按钮）
  - [ ] Subtask 2.2: 添加基础文件验证（格式JPG/PNG/GIF，大小≤2MB，尺寸≤3840x3840px）
  - [ ] Subtask 2.3: 实现上传状态显示（上传中/成功/失败）
  - [ ] Subtask 2.4: 显示上传结果（文件URL或错误消息）

### 来自Story 0.9.2-MVP的任务
- [ ] Task 3: 实现网络错误处理 (AC: 4)
  - [ ] Subtask 3.1: 检测网络连接错误和超时
  - [ ] Subtask 3.2: 实现简单的重试机制（最多3次，间隔2秒）
  - [ ] Subtask 3.3: 重试失败后显示"网络连接问题，请检查网络后重试"

- [ ] Task 4: 实现文件和服务错误处理 (AC: 3)
  - [ ] Subtask 4.1: 建立统一的错误消息常量和分类
  - [ ] Subtask 4.2: 实现文件验证错误处理（格式、大小）
  - [ ] Subtask 4.3: 实现R-Cabinet API错误处理（认证、服务不可用）
  - [ ] Subtask 4.4: 添加"重新选择文件"和"重试"操作按钮

- [ ] Task 5: 优化错误信息显示 (AC: 3)
  - [ ] Subtask 5.1: 创建统一的错误提示组件
  - [ ] Subtask 5.2: 使用图标和颜色区分不同类型错误
  - [ ] Subtask 5.3: 确保所有错误信息符合中文用户习惯

### 系统兼容性任务
- [ ] Task 6: 确保系统兼容性 (AC: 5,6)
  - [ ] Subtask 6.1: 验证新功能不影响现有页面编辑器
  - [ ] Subtask 6.2: 添加功能开关 `RCABINET_UPLOAD_ENABLED`
  - [ ] Subtask 6.3: 创建基础的集成测试

## Dev Technical Guidance

### MVP技术原则
- **简单优先**: 使用最简单的技术实现，避免过度设计
- **同步处理**: 不使用队列，直接上传
- **基础验证**: 只检查必要的文件属性
- **最小依赖**: 复用现有组件和库
- **快速迭代**: 专注核心功能，后续版本再优化

### 基于Story 0.8的集成要求
- **认证机制**: 复用Story 0.8已验证的ESA Base64编码认证
- **API端点**: 使用`POST /es/1.0/cabinet/file/insert`
- **错误处理**: 扩展Story 0.8的基础错误处理框架
- **功能开关**: 使用Story 0.8建立的功能开关机制

### 文件结构（最小化）
```
apps/backend/pagemaker/media/views/simple_upload.py  # 后端上传逻辑
apps/frontend/src/components/media/SimpleUpload.tsx  # 前端上传组件
apps/backend/integrations/tests/test_simple_upload.py  # 基础测试
```

### 错误消息设计（来自0.9.2-MVP）
```typescript
const ERROR_MESSAGES = {
  NETWORK_ERROR: "网络连接问题，请检查网络后重试",
  FILE_TOO_LARGE: "文件大小不能超过2MB，请选择较小的文件",
  IMAGE_TOO_LARGE: "图片尺寸不能超过3840x3840像素，请选择较小尺寸的图片",
  INVALID_FORMAT: "仅支持JPG、PNG、GIF格式，请选择正确格式的图片",
  SERVICE_ERROR: "上传服务暂时不可用，请稍后重试",
  AUTH_ERROR: "服务认证失败，请联系管理员"
}
```

### 不在MVP范围内（移至后续版本）
- ❌ 文件夹管理功能
- ❌ 文件元数据获取和管理
- ❌ 上传进度条
- ❌ 分块上传
- ❌ 批量上传
- ❌ 缩略图生成
- ❌ 高级错误重试（指数退避）
- ❌ 复杂降级策略
- ❌ 服务健康检查和监控
- ❌ 恶意文件检测
- ❌ 性能监控和分析
- ❌ 国际化支持
- ❌ 用户权限管理
- ❌ 详细日志记录

## Testing

### 来自子故事的测试要求
- [ ] Unit Tests: 后端上传逻辑测试，覆盖率≥70%
- [ ] Component Tests: 前端上传组件测试，覆盖率≥70%
- [ ] Integration Tests: 端到端上传流程测试
- [ ] 兼容性测试: 现有功能不受影响

### 手动测试清单（MVP精简版）
1. **基础上传测试**（来自0.9.1-MVP）:
   - 拖拽JPG文件到上传区域，验证成功上传
   - 点击选择PNG文件，验证成功上传
   - 尝试上传超过2MB的文件，验证被拒绝
   - 尝试上传不支持格式，验证错误提示

2. **错误处理测试**（来自0.9.2-MVP）:
   - 断网状态下上传，验证重试和最终错误提示
   - 上传4MB大文件，验证大小错误提示
   - 上传.txt文件，验证格式错误提示
   - 模拟R-Cabinet服务不可用，验证服务错误提示

3. **兼容性测试**:
   - 验证现有页面编辑器功能正常
   - 测试功能开关的启用/禁用效果

## Definition of Done

- ✅ 用户可以成功上传单个图片文件
- ✅ 上传成功后获得可用的文件URL
- ✅ 网络错误时自动重试3次
- ✅ 上传失败时看到清晰的中文错误消息
- ✅ 现有功能完全不受影响
- ✅ 基础测试通过
- ✅ 代码简洁，无过度设计
- ✅ 功能开关正常工作

## 后续版本规划

**v1.1可考虑**（基于当前MVP的自然扩展）:
- 上传进度显示
- 批量上传
- 更好的错误处理和重试策略

**v1.2可考虑**（增强功能）:
- 用户权限管理
- 上传历史记录
- 文件夹管理

**v2.0可考虑**（高级功能）:
- 监控和告警
- 高级性能优化
- 安全扫描和恶意文件检测

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) 记录开发过程中的关键调试信息]]

### Completion Notes List

[[LLM: (Dev Agent) 记录实现过程中的重要决策和偏差]]

### File List

[[LLM: (Dev Agent) 列出所有新创建或修改的文件]]

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024-12-19 | 0.1 | 原始复杂版本，包含过多非MVP功能 | SM |
| 2024-12-19 | 1.0 | 重构为MVP版本，专注核心价值，与子故事保持一致 | PO Sarah |

## QA Results

[[LLM: QA Agent Results]] 