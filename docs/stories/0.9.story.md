# Story 0.9: R-Cabinet集成原型和错误处理

## Status: APPROVED

## Story

- As a 开发者
- I want 建立稳定的R-Cabinet集成机制
- so that 图片上传功能能够可靠工作，并有完善的错误处理和用户反馈

## Acceptance Criteria (ACs)

1. 实现R-Cabinet API的基础连接和认证机制。
2. 创建图片上传的原型功能，包含进度显示和错误处理。
3. 实现文件格式验证和大小限制检查。
4. 设计用户友好的错误提示和重试机制。
5. 建立R-Cabinet服务的健康检查和降级策略。
6. 文档化R-Cabinet集成的最佳实践和限制。

## User Actions Required

**重要**: 以下操作需要业务方或项目管理员手动完成，开发者无法自动化这些步骤：

### R-Cabinet API生产凭据配置
- [x] **API凭据获取** (需要乐天账户管理员):
  - 确认乐天RMS账户的R-Cabinet功能访问权限
  - 获取生产环境的`serviceSecret`和`licenseKey`
  - 验证凭据的权限范围（文件上传、文件夹管理权限）
  - 确认凭据的有效期限和使用配额限制

### 测试环境准备
- [x] **文件上传测试准备** (需要测试数据准备):
  - 准备各种格式的测试图片文件（JPG, PNG, GIF, TIFF, BMP）
  - 准备超大文件用于限制测试（>2MB, >3840x3840px）
  - 准备恶意文件样本用于安全测试
  - 确认测试环境的网络访问权限

**注意**: 如果无法获取真实凭据，开发将在模拟模式下完成，但需要在获得真实凭据后进行额外的集成验证。

## Tasks / Subtasks

- [ ] Task 1: 增强R-Cabinet API客户端实现 (AC: 1)
  - [ ] Subtask 1.1: 基于Story 0.8的基础代码，实现完整的文件上传功能
  - [ ] Subtask 1.2: 实现文件夹管理功能（创建、列表、删除）
  - [ ] Subtask 1.3: 实现文件元数据获取和管理功能
  - [ ] Subtask 1.4: 优化认证机制，支持凭据自动刷新和错误恢复
  - [ ] Subtask 1.5: 实现API响应的完整XML解析和数据提取

- [ ] Task 2: 实现图片上传原型功能 (AC: 2)
  - [ ] Subtask 2.1: 审查现有`pagemaker/media/`应用，确保API端点不冲突
  - [ ] Subtask 2.2: 创建前端图片上传组件，集成现有设计系统
  - [ ] Subtask 2.3: 实现上传进度显示和取消功能
  - [ ] Subtask 2.4: 创建后端文件上传处理端点（避免与现有端点冲突）
  - [ ] Subtask 2.5: 实现基础文件上传（MVP范围，延迟分块上传到后续版本）
  - [ ] Subtask 2.6: 集成R-Cabinet API进行实际文件上传
  - [ ] Subtask 2.7: 实现上传结果的前端展示和状态更新
  - [ ] Subtask 2.8: 添加现有功能的回归测试

- [ ] Task 3: 实现文件验证和限制检查 (AC: 3)
  - [ ] Subtask 3.1: 实现前端文件格式验证（JPG, GIF, PNG, TIFF, BMP）
  - [ ] Subtask 3.2: 实现文件大小限制检查（最大2MB）
  - [ ] Subtask 3.3: 实现图片尺寸验证（最大3840x3840px）
  - [ ] Subtask 3.4: 创建文件类型检测和MIME类型验证
  - [ ] Subtask 3.5: 实现后端二次验证，防止前端绕过
  - [ ] Subtask 3.6: 添加恶意文件检测和安全扫描

- [ ] Task 4: 设计用户友好的错误处理 (AC: 4)
  - [ ] Subtask 4.1: 创建统一的错误消息国际化系统
  - [ ] Subtask 4.2: 实现智能重试机制（指数退避、最大重试次数）
  - [ ] Subtask 4.3: 设计错误状态的UI组件和用户提示
  - [ ] Subtask 4.4: 实现网络错误、认证错误、配额错误的专门处理
  - [ ] Subtask 4.5: 创建错误恢复建议和用户操作指导
  - [ ] Subtask 4.6: 实现错误日志记录和用户反馈收集

- [ ] Task 5: 建立健康检查和降级策略 (AC: 5)
  - [ ] Subtask 5.1: 实现R-Cabinet服务可用性检测
  - [ ] Subtask 5.2: 实现功能开关机制（环境变量控制）
  - [ ] Subtask 5.3: 实现降级模式（本地存储、队列延迟上传）
  - [ ] Subtask 5.4: 创建服务健康状态监控和告警
  - [ ] Subtask 5.5: 设计服务恢复后的数据同步机制
  - [ ] Subtask 5.6: 实现用户通知和服务状态展示
  - [ ] Subtask 5.7: 创建回滚程序和紧急禁用机制

- [ ] Task 6: 文档化集成最佳实践 (AC: 6)
  - [ ] Subtask 6.1: 更新`docs/rakuten-api-integration.md`，添加实际集成经验
  - [ ] Subtask 6.2: 创建开发者集成指南和代码示例
  - [ ] Subtask 6.3: 文档化性能优化建议和限制说明
  - [ ] Subtask 6.4: 创建故障排除指南和常见问题解答
  - [ ] Subtask 6.5: 记录安全考虑和最佳实践
  - [ ] Subtask 6.6: 创建用户使用指南和功能说明

- [ ] Task 7: 实现监控和用户反馈收集 (MVP后增强)
  - [ ] Subtask 7.1: 实现文件上传使用情况分析
  - [ ] Subtask 7.2: 收集用户上传行为数据
  - [ ] Subtask 7.3: 实现错误率和性能监控
  - [ ] Subtask 7.4: 创建运营仪表板

## Dev Technical Guidance

### MVP范围明确
- **核心功能**: 单文件上传、基础验证、错误处理、进度显示
- **MVP后功能**: 分块上传、缩略图生成、CDN缓存、批量上传、高级图片处理
- **延迟功能**: 图片编辑、水印添加、自动压缩优化

### Previous Story Insights
- Story 0.8已建立了基础的R-Cabinet连接测试和错误处理框架，包括模拟模式和真实API调用的切换机制
- 已实现的降级策略包括断路器模式、功能开关、缓存降级等，可在此基础上扩展
- 现有的`apps/backend/pagemaker/integrations/`模块提供了良好的代码组织结构

### R-Cabinet API集成要求
- **认证机制**: 使用ESA Base64编码的serviceSecret:licenseKey格式，已在Story 0.8中验证 [Source: docs/rakuten-api-integration.md#认证机制]
- **文件上传端点**: `POST /es/1.0/cabinet/file/insert`，支持multipart/form-data格式，最大文件2MB [Source: docs/rakuten-api-integration.md#文件上传]
- **支持格式**: JPG, GIF, 动画GIF, PNG, TIFF, BMP（PNG/TIFF/BMP自动转换为JPG） [Source: docs/rakuten-api-integration.md#支持的文件格式]
- **速率限制**: 每秒1次请求，需要实现请求队列管理 [Source: architecture/external-integrations.md]
- **错误处理**: 统一的resultCode错误映射和HTTP状态码处理 [Source: docs/rakuten-api-integration.md#错误处理策略]

### 前端组件架构
- **上传组件**: 使用shadcn/ui组件库创建拖拽上传界面 [Source: architecture/tech-stack.md]
- **状态管理**: 使用ahooks的useRequest进行上传状态管理 [Source: architecture/tech-stack.md]
- **进度显示**: 实现实时上传进度条和状态反馈
- **错误处理**: 集成统一的错误提示组件和重试机制
- **设计系统一致性**: 确保上传组件与现有页面编辑器UI风格一致
- **用户反馈**: 实现上传成功/失败的用户友好提示
- **可访问性**: 支持键盘导航和屏幕阅读器

### 后端API设计
- **上传端点**: 创建`POST /api/v1/media/upload/`端点处理文件上传 [Source: architecture/rest-api-spec.md]
- **验证中间件**: 实现文件类型、大小、尺寸的多层验证
- **异步处理**: 使用Celery队列处理大文件上传和R-Cabinet API调用
- **存储策略**: 实现本地临时存储和R-Cabinet远程存储的双重机制

### 文件位置和项目结构
- **集成模块**: 扩展`apps/backend/pagemaker/integrations/`，添加文件上传和管理功能 [Source: architecture/unified-project-structure.md]
- **前端组件**: 在`apps/frontend/components/media/`创建上传相关组件
- **API端点**: 在`apps/backend/pagemaker/media/`应用中添加上传API
- **测试文件**: 集成测试放在`apps/backend/integrations/tests/`目录

### 现有系统集成安全要求
- **API端点冲突检查**: 新的`POST /api/v1/media/upload/`端点必须与现有media应用API进行冲突检查 [Source: architecture/rest-api-spec.md]
- **数据库Schema兼容性**: 确保新增的文件元数据表不与现有media模型冲突
- **权限系统集成**: 文件上传权限必须与现有用户权限系统无缝集成
- **现有功能保护**: 实现集成测试确保现有页面编辑功能不受影响

### 回滚和降级策略
- **功能开关实现**: 实现`RCABINET_UPLOAD_ENABLED`环境变量控制功能启用/禁用
- **数据迁移回滚**: 如有数据库schema变更，提供完整的迁移回滚脚本
- **API版本控制**: 新API端点支持版本控制，便于后续升级和回滚
- **监控告警**: 实现文件上传失败率、响应时间等关键指标监控

### 安全和性能要求
- **文件验证**: 实现MIME类型检测、文件头验证、恶意文件扫描 [Source: architecture/security-and-performance.md]
- **访问控制**: 确保只有认证用户能够上传文件，实现用户隔离
- **性能优化**: 实现文件压缩、缩略图生成、CDN缓存策略
- **监控日志**: 记录所有上传操作、错误情况和性能指标

### 错误处理和用户体验
- **统一错误格式**: 使用现有的error.code、error.message、error.details结构 [Source: architecture/error-handling-strategy.md]
- **国际化支持**: 错误消息支持中文和英文显示
- **重试策略**: 实现指数退避重试，最大重试3次
- **降级处理**: 服务不可用时提供本地存储和离线模式

### 测试要求
- **单元测试**: 使用Pytest测试所有上传逻辑和错误处理 [Source: architecture/testing-strategy.md]
- **集成测试**: 测试完整的上传流程，包括前后端交互
- **性能测试**: 测试大文件上传和并发上传场景
- **安全测试**: 测试恶意文件上传和权限绕过攻击

## Testing

Dev Note: Story Requires the following tests:

- [ ] Pytest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Pytest Integration Test (Test Location): location: `apps/backend/integrations/tests/test_file_upload.py`
- [ ] Vitest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Playwright E2E: location: `apps/frontend/e2e/file-upload.spec.ts`

Manual Test Steps:
- **文件上传测试**:
  1. 测试不同格式文件的上传（JPG, PNG, GIF等）
  2. 验证文件大小限制（超过2MB的文件应被拒绝）
  3. 测试图片尺寸限制（超过3840x3840px的图片处理）
  4. 验证拖拽上传和点击选择两种方式
  5. 测试上传进度显示和取消功能
  6. 模拟网络错误和服务不可用情况
- **错误处理测试**:
  7. 测试无效凭据的错误提示
  8. 验证配额不足时的用户提示
  9. 测试重试机制的触发和限制
  10. 验证降级模式的激活和恢复
- **安全测试**:
  11. 尝试上传恶意文件（应被阻止）
  12. 测试未认证用户的访问控制
  13. 验证文件类型伪造的检测
- **集成安全测试**:
  14. 验证现有页面编辑功能不受影响
  15. 测试现有media API端点正常工作
  16. 验证用户权限系统正确集成
  17. 测试功能开关的启用/禁用效果
  18. 验证回滚程序的完整性
- **性能基准测试**:
  19. 测试文件上传对现有系统性能的影响
  20. 验证并发上传的系统稳定性
  21. 测试大量文件上传后的系统响应时间

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (SM Agent) When Drafting Story, leave next prompt in place for dev agent to remove and update]]
[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (SM Agent) When Drafting Story, leave next prompt in place for dev agent to remove and update - remove this line to the SM]]
[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### File List

[[LLM: (Dev Agent) List every new file created, or existing file modified in a bullet list.]]

### Change Log

[[LLM: (SM Agent) When Drafting Story, leave next prompt in place for dev agent to remove and update- remove this line to the SM]]
[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]] 