# Story 1.1: 可视化编辑器基本框架

## Status: APPROVED

## Story

- As a 运营专员
- I want 能在一个可视化的编辑界面中搭建页面布局
- so that 能直观地安排内容模块，并能实时预览大致效果

## Acceptance Criteria (ACs)

1. CMS界面包含清晰划分的模块列表区、编辑画布区、属性编辑区。
2. 用户能将注意力集中在画布区进行编排。
3. 画布区能大致反映页面的实时预览效果，并随配置更改而更新。
4. 编辑器界面在主流桌面浏览器上能正确显示和操作。
5. 用户能清晰地选择或看到当前正在编辑的乐天店铺"目标区域"。

## Tasks / Subtasks

- [ ] Task 1: 创建编辑器主界面布局结构 (AC: 1, 2)
  - [ ] Subtask 1.1: 基于shadcn/ui创建三栏布局组件 (模块列表区、画布区、属性编辑区)
  - [ ] Subtask 1.2: 实现响应式布局，确保在不同桌面分辨率下正确显示
  - [ ] Subtask 1.3: 添加可调节的分割条，允许用户调整各区域宽度
  - [ ] Subtask 1.4: 创建模块列表区的基础UI结构和样式
  - [ ] Subtask 1.5: 创建属性编辑区的基础UI框架

- [ ] Task 2: 实现画布区预览功能 (AC: 3)
  - [ ] Subtask 2.1: 创建画布区容器组件，支持模块渲染
  - [ ] Subtask 2.2: 实现基础的模块预览渲染引擎
  - [ ] Subtask 2.3: 集成Zustand状态管理，实现画布内容实时更新
  - [ ] Subtask 2.4: 添加画布滚动功能
  - [ ] Subtask 2.5: 实现模块选择状态的视觉反馈

- [ ] Task 3: 实现目标区域选择功能 (AC: 5)
  - [ ] Subtask 3.1: 创建目标区域选择下拉组件
  - [ ] Subtask 3.2: 集成店铺配置API获取可用目标区域列表
  - [ ] Subtask 3.3: 实现目标区域切换时的状态管理
  - [ ] Subtask 3.4: 在界面头部显示当前选中的目标区域
  - [ ] Subtask 3.5: 保存用户的目标区域选择到页面数据模型

- [ ] Task 4: 建立前端路由和导航结构 (AC: 4)
  - [ ] Subtask 4.1: 配置Next.js App Router，创建编辑器路由 `/editor/[pageId]`
  - [ ] Subtask 4.2: 实现受保护路由，确保只有登录用户可访问编辑器
  - [ ] Subtask 4.3: 创建编辑器顶部导航栏，包含保存、预览、返回按钮
  - [ ] Subtask 4.4: 测试编辑器在Chrome、Firefox、Safari桌面版的兼容性
  - [ ] Subtask 4.5: 实现基础的页面保存功能

- [ ] Task 5: 集成页面数据管理 (AC: 3, 5)
  - [ ] Subtask 5.1: 创建pageService，实现页面CRUD API调用
  - [ ] Subtask 5.2: 使用SWR实现页面数据的获取和缓存
  - [ ] Subtask 5.3: 实现基础的页面保存功能
  - [ ] Subtask 5.4: 集成加载状态和错误处理UI

## Dev Technical Guidance

### Previous Story Context
- Story 0.9已完成R-Cabinet集成原型，建立了媒体文件上传基础设施
- MediaFile数据模型已创建，支持图片上传和管理功能
- 基础的Django API结构已就绪，包含认证和权限系统

### Frontend Architecture Requirements
- **状态管理**: 使用Zustand创建多个Store [Source: architecture/frontend-architecture.md#状态管理架构]
  - `usePageStore.ts`: 管理当前正在编辑页面的核心数据
  - `useEditorStore.ts`: 管理编辑器本身的UI状态
- **API集成**: 使用SWR + Axios模式 [Source: architecture/frontend-architecture.md#API集成架构]
- **路由保护**: 使用Next.js App Router的路由组保护编辑器页面 [Source: architecture/frontend-architecture.md#路由架构]

### UI Component Architecture
- **基础组件库**: shadcn/ui 2.6 [Source: architecture/tech-stack.md]
- **样式方案**: Tailwind CSS 4.1功能类 + CSS Modules补充 [Source: architecture/frontend-architecture.md#样式指南]
- **布局策略**: 三栏布局，支持响应式调整
- **组件结构**: 组件文件与测试文件并置存放 [Source: architecture/testing-strategy.md]

### Data Model Integration
- **PageTemplate模型**: JSON content字段存储模块配置 [Source: architecture/data-models.md#PageTemplate]
- **目标区域**: target_area字段关联店铺配置 [Source: architecture/data-models.md#ShopConfiguration]
- **共享类型**: 使用packages/shared-types定义PageModule和PageTemplate接口 [Source: architecture/coding-standards.md#关键编码规则]

### API Endpoints Required
- `GET /api/v1/pages/{id}/`: 获取页面详细信息 [Source: architecture/components.md#页面管理组件]
- `PUT /api/v1/pages/{id}/`: 更新页面内容 [Source: architecture/components.md#页面管理组件]
- `GET /api/v1/shop-configurations/`: 获取目标区域列表 [Source: architecture/components.md#店铺配置组件]

### File Structure - Frontend
```
apps/frontend/src/
├── app/
│   ├── (protected)/
│   │   └── editor/
│   │       └── [pageId]/
│   │           └── page.tsx
│   └── layout.tsx
├── components/
│   ├── editor/
│   │   ├── EditorLayout.tsx
│   │   ├── ModuleList.tsx
│   │   ├── Canvas.tsx
│   │   └── PropertyPanel.tsx
│   └── ui/ (shadcn/ui components)
├── stores/
│   ├── usePageStore.ts
│   └── useEditorStore.ts
├── services/
│   └── pageService.ts
└── lib/
    └── apiClient.ts
```

### Store State Design
```typescript
// usePageStore.ts
interface PageState {
  currentPage: PageTemplate | null;
  selectedModuleId: string | null;
  targetArea: string;
  setPage: (page: PageTemplate) => void;
  updateModule: (moduleId: string, updates: Partial<PageModule>) => void;
  setTargetArea: (area: string) => void;
}

// useEditorStore.ts  
interface EditorState {
  isLoading: boolean;
  hasUnsavedChanges: boolean;
  setLoading: (loading: boolean) => void;
  markUnsaved: () => void;
  markSaved: () => void;
}
```

### Component Specifications
- **EditorLayout**: 三栏布局容器，处理区域大小调整
- **ModuleList**: 显示可用模块列表，暂时展示空列表占位
- **Canvas**: 模块渲染容器，支持选择和预览
- **PropertyPanel**: 属性编辑面板，根据选中模块动态显示

### Integration with Existing Codebase
- **认证系统**: 集成现有JWT认证，使用受保护路由 [Source: architecture/components.md#认证组件]
- **API客户端**: 复用现有的axios配置和拦截器
- **用户权限**: 确保用户只能编辑自己的页面

### Browser Compatibility Requirements
- Chrome 90+, Firefox 88+, Safari 14+
- 最小屏幕宽度: 1280px (桌面优先设计)
- 支持键盘导航和基础无障碍访问

### Error Handling Strategy
- 网络错误: 显示重试选项
- 权限错误: 重定向到登录页
- 数据冲突: 显示冲突解决界面
- 浏览器兼容性: 显示升级浏览器提示

## Testing

Dev Note: Story Requires the following tests:

- [ ] Vitest Unit Tests: (nextToFile: true), coverage requirement: 80%
  - **测试范围**: Store状态管理逻辑、组件渲染、API服务调用
  - **关键测试用例**: PageStore状态更新、EditorStore UI状态、组件交互、目标区域切换
  - **模拟策略**: Mock API调用、模拟SWR缓存、模拟用户交互

- [ ] Vitest Integration Test (Test Location): location: `apps/frontend/src/components/editor/__tests__/editor-integration.test.tsx`
  - **测试内容**: 完整的编辑器加载和交互流程
  - **测试场景**: 页面加载、目标区域切换、状态同步、错误处理
  - **环境要求**: 模拟完整API响应和用户认证状态

- [ ] Playwright E2E: location: `e2e/editor/basic-editor-workflow.test.ts`
  - **测试流程**: 登录→进入编辑器→加载页面→切换目标区域→保存页面
  - **浏览器覆盖**: Chrome (主要浏览器)
  - **基础功能测试**: 三栏布局显示和基本交互

Manual Test Steps:
- **基础界面测试**:
  1. 登录系统并导航到编辑器页面
  2. 验证三栏布局正确显示（模块列表、画布、属性面板）
  3. 测试分割条拖拽调整区域宽度
  4. 验证目标区域选择下拉正常工作
- **基础功能测试**:
  5. 测试页面加载和数据获取
  6. 验证基础保存功能正常工作
  7. 验证加载状态和错误提示正确显示

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### File List

[[LLM: (Dev Agent) List every new file created, or existing file modified in a bullet list.]]

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]] 