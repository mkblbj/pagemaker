# Story 1.6: 单张图片模块集成与配置

## Status: approved

## Story

**As a** 运营专员,
**I want** 能够在Pagemaker编辑器中使用"单张图片模块"，并能从本地上传新图片到R-Cabinet、从R-Cabinet中选择已有图片、设置alt文本、对齐方式、添加链接和调整显示尺寸,
**so that** 在页面中灵活地展示图片。

## Acceptance Criteria

1. 用户能将"单张图片模块"添加到画布上。
2. 用户能从本地上传新图片到R-Cabinet，或从R-Cabinet中选择已有图片。
3. 用户能为图片设置"alt"文本。
4. 用户能为图片设置对齐方式。
5. 用户能为图片添加多种类型的超链接（URL、Email、Phone、Anchor）。
6. 用户能通过预设选项或百分比调整图片显示尺寸。
7. 导出的HTML能正确反映所有配置。
8. 编辑器中的预览能实时更新。

## Tasks / Subtasks

### 前端图片模块组件开发
- [ ] 创建ImageModule组件 (AC: 1, 8) [Source: frontend-architecture.md#components]
  - [ ] 实现基础图片渲染组件 `apps/frontend/src/components/modules/ImageModule.tsx`
  - [ ] 支持图片选择和上传界面
  - [ ] 集成到模块列表中，支持拖拽添加到画布
  - [ ] 实现实时预览更新机制

### 图片上传和选择功能
- [ ] 实现R-Cabinet集成 (AC: 2) [Source: external-integrations.md#rakuten-cabinet]
  - [ ] 创建图片上传服务 `apps/frontend/src/services/imageService.ts`
  - [ ] 实现本地文件选择和上传界面
  - [ ] 实现R-Cabinet图片浏览和选择界面
  - [ ] 处理上传进度和错误状态

### 图片属性配置
- [ ] 实现图片属性面板 (AC: 3, 4, 5, 6) [Source: frontend-architecture.md#components]
  - [ ] Alt文本输入框
  - [ ] 对齐方式选择器（左对齐、居中、右对齐）
  - [ ] 链接类型选择器和输入框（URL、Email、Phone、Anchor）
  - [ ] 尺寸调整控件（预设选项和百分比调节）

### 后端R-Cabinet API集成
- [ ] 实现媒体上传API (AC: 2) [Source: backend-architecture.md#service-architecture]
  - [ ] 创建媒体上传端点 `apps/backend/pagemaker/media/views.py`
  - [ ] 实现R-Cabinet API客户端 `apps/backend/pagemaker/media/services.py`
  - [ ] 处理文件验证和格式转换
  - [ ] 实现错误处理和重试机制

### 状态管理集成
- [ ] 扩展编辑器状态管理 (AC: 1, 8) [Source: frontend-architecture.md#state-management]
  - [ ] 更新usePageStore以支持图片模块
  - [ ] 实现图片模块的状态持久化
  - [ ] 支持撤销/重做功能

### HTML导出功能
- [ ] 实现图片模块HTML导出 (AC: 7) [Source: architecture/components.md]
  - [ ] 更新htmlExportService支持ImageModule
  - [ ] 生成语义化的img标签结构
  - [ ] 正确导出所有图片属性和样式
  - [ ] 确保与乐天店铺环境兼容

### 测试实现
- [ ] 编写单元测试 [Source: testing-strategy.md]
  - [ ] ImageModule组件测试 `apps/frontend/src/components/modules/ImageModule.test.tsx`
  - [ ] 图片服务测试 `apps/frontend/src/services/imageService.test.ts`
  - [ ] 后端媒体API测试 `apps/backend/pagemaker/media/tests/test_views.py`
  - [ ] HTML导出测试更新

## Dev Notes

### Previous Story Insights
从故事1.5的实现中了解到：
- 模块组件需要实现内联编辑功能和属性面板配置
- 状态管理需要支持实时预览和撤销/重做
- HTML导出需要生成语义化结构并确保乐天环境兼容
- 测试需要覆盖组件渲染、用户交互和无障碍访问性

### Data Models
**PageModule接口扩展** [Source: data-models.md#pagetemplate]
```typescript
interface ImageModule extends PageModule {
  type: 'image';
  config: {
    src: string; // R-Cabinet图片URL
    alt: string; // Alt文本
    alignment: 'left' | 'center' | 'right'; // 对齐方式
    link?: {
      type: 'url' | 'email' | 'phone' | 'anchor';
      value: string;
    }; // 超链接配置
    size: {
      type: 'preset' | 'percentage';
      value: string; // 预设名称或百分比值
    }; // 尺寸配置
  };
}
```

### API Specifications
**媒体上传API** [Source: rest-api-spec.md, external-integrations.md#rakuten-cabinet]
- `POST /api/v1/media/upload` - 上传图片到R-Cabinet
- `GET /api/v1/media/cabinet-images` - 获取R-Cabinet中的图片列表
- R-Cabinet API认证：`Authorization: ESA Base64(serviceSecret:licenseKey)`
- 速率限制：每秒1次请求
- 数据格式：XML（R-Cabinet API）

### Component Specifications
**ImageModule组件结构** [Source: frontend-architecture.md#components]
```tsx
// apps/frontend/src/components/modules/ImageModule.tsx
interface ImageModuleProps {
  module: ImageModule;
  isSelected: boolean;
  onUpdate: (updates: Partial<ImageModule>) => void;
  onSelect: () => void;
}
```

### File Locations
**前端文件路径** [Source: unified-project-structure.md]
- 组件：`apps/frontend/src/components/modules/ImageModule.tsx`
- 服务：`apps/frontend/src/services/imageService.ts`
- 测试：`apps/frontend/src/components/modules/ImageModule.test.tsx`

**后端文件路径** [Source: unified-project-structure.md]
- 视图：`apps/backend/pagemaker/media/views.py`
- 服务：`apps/backend/pagemaker/media/services.py`
- 测试：`apps/backend/pagemaker/media/tests/test_views.py`

### Testing Requirements
**测试框架和位置** [Source: testing-strategy.md]
- 前端测试：Vitest + React Testing Library，测试文件与组件并置
- 后端测试：Pytest，测试文件在各App的`tests/`目录
- 测试数据库：使用现有开发数据库，`CREATE_DB = False`
- 覆盖范围：单元测试（组件、服务）、集成测试（API）、HTML导出测试

### Technical Constraints
**技术栈要求** [Source: tech-stack.md]
- 前端：TypeScript ~5.x, Next.js 15.3, shadcn/ui 2.6, Tailwind CSS 4.1
- 后端：Python ~3.12, Django ~5.1, DRF ~3.15
- 测试：Vitest ~3.2.4 (前端), Pytest ~8.2 (后端)

**编码规范** [Source: coding-standards.md]
- 必须使用仓库模式：后端视图严禁直接调用Django ORM
- 必须使用共享类型：在`packages/shared-types`中定义ImageModule接口
- 必须使用服务层：前端组件严禁直接调用axios或fetch
- 严禁硬编码：所有常量值必须在专门的常量文件中定义

### Project Structure Notes
所有文件路径和模块位置都与unified-project-structure.md中定义的结构一致。新增的ImageModule将遵循与TextModule相同的组件架构模式。

### Testing

**测试文件位置** [Source: testing-strategy.md#test-organization]
- 前端测试文件与被测试组件并置存放
- 后端测试文件位于各Django App内的`tests/`目录

**测试框架** [Source: testing-strategy.md#test-scope]
- 前端：Vitest + React Testing Library
- 后端：Pytest
- 外部依赖必须被模拟（Mock）

**具体测试要求**
- 单元测试：测试ImageModule组件渲染、图片选择、属性配置
- 集成测试：测试R-Cabinet API集成、文件上传流程
- HTML导出测试：验证导出的HTML结构和属性正确性
- 无障碍访问性测试：确保alt文本和键盘导航支持

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-28 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*Agent model and version will be recorded here*

### Debug Log References

*Debug log references will be added here*

### Completion Notes List

*Completion notes will be added here*

### File List

*File list will be added here*

## QA Results

*Results from QA Agent QA review will be added here* 