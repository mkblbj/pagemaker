# CI/CD ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

Pagemaker é¡¹ç›®ä½¿ç”¨ GitHub Actions å®ç°è‡ªåŠ¨åŒ–çš„æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰æµç¨‹ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å·¥ä½œæµé…ç½®ã€ä½¿ç”¨æ–¹æ³•å’Œæ•…éšœæ’é™¤æ­¥éª¤ã€‚

## å·¥ä½œæµæ¦‚è§ˆ

### 1. CI å·¥ä½œæµ (`.github/workflows/ci.yml`)

**è§¦å‘æ¡ä»¶:**
- æ¨é€åˆ° `main` æˆ– `develop` åˆ†æ”¯
- å‘ `main` æˆ– `develop` åˆ†æ”¯æäº¤ Pull Request

**æ‰§è¡Œå†…å®¹:**
- å‰ç«¯ä»£ç æ£€æŸ¥ï¼ˆESLintã€Prettierã€TypeScriptï¼‰
- åç«¯ä»£ç æ£€æŸ¥ï¼ˆFlake8ã€Blackï¼‰
- å‰åç«¯å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- å…±äº«ç±»å‹åŒ…æµ‹è¯•
- ä»£ç è¦†ç›–ç‡æ£€æŸ¥ï¼ˆâ‰¥80%ï¼‰

### 2. è¦†ç›–ç‡æŠ¥å‘Šå·¥ä½œæµ (`.github/workflows/coverage.yml`)

**è§¦å‘æ¡ä»¶:**
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯

**æ‰§è¡Œå†…å®¹:**
- ç”Ÿæˆè¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Š
- åœ¨ PR ä¸­è‡ªåŠ¨è¯„è®ºè¦†ç›–ç‡å˜åŒ–
- ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° GitHub Actions artifacts

### 3. å®‰å…¨æ‰«æå·¥ä½œæµ (`.github/workflows/security.yml`)

**è§¦å‘æ¡ä»¶:**
- æ¨é€åˆ° `main` æˆ– `develop` åˆ†æ”¯
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯
- æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹å®šæ—¶æ‰§è¡Œ

**æ‰§è¡Œå†…å®¹:**
- CodeQL å®‰å…¨åˆ†æï¼ˆJavaScript å’Œ Pythonï¼‰
- å‰ç«¯ä¾èµ–æ¼æ´æ‰«æï¼ˆnpm auditï¼‰
- åç«¯ä¾èµ–æ¼æ´æ‰«æï¼ˆSafety + Banditï¼‰
- ä¾èµ–è®¸å¯è¯æ£€æŸ¥

### 4. éƒ¨ç½²å·¥ä½œæµ (`.github/workflows/deploy.yml`)

**è§¦å‘æ¡ä»¶:**
- æ¨é€åˆ° `main` åˆ†æ”¯
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œå†…å®¹:**
- å‰ç«¯éƒ¨ç½²åˆ° Vercel
- åç«¯éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
- éƒ¨ç½²åå¥åº·æ£€æŸ¥
- éƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

## è´¨é‡é—¨ç¦

### ä»£ç è¦†ç›–ç‡è¦æ±‚
- **å‰ç«¯è¦†ç›–ç‡**: â‰¥80%
- **åç«¯è¦†ç›–ç‡**: â‰¥80%
- è¦†ç›–ç‡ä¸è¾¾æ ‡æ—¶å·¥ä½œæµä¼šå¤±è´¥

### ä»£ç è´¨é‡è¦æ±‚
- æ‰€æœ‰ ESLint è§„åˆ™å¿…é¡»é€šè¿‡
- ä»£ç å¿…é¡»é€šè¿‡ Prettier æ ¼å¼æ£€æŸ¥
- Python ä»£ç å¿…é¡»é€šè¿‡ Flake8 å’Œ Black æ£€æŸ¥
- TypeScript ç±»å‹æ£€æŸ¥å¿…é¡»é€šè¿‡

### å®‰å…¨è¦æ±‚
- ä¸èƒ½æœ‰ä¸­ç­‰åŠä»¥ä¸Šçº§åˆ«çš„å®‰å…¨æ¼æ´
- ä¾èµ–è®¸å¯è¯å¿…é¡»ç¬¦åˆç™½åå•è¦æ±‚
- CodeQL æ‰«æä¸èƒ½å‘ç°ä¸¥é‡å®‰å…¨é—®é¢˜

## ä½¿ç”¨æŒ‡å—

### å¼€å‘æµç¨‹

1. **åˆ›å»ºåŠŸèƒ½åˆ†æ”¯**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **æœ¬åœ°å¼€å‘å’Œæµ‹è¯•**
   ```bash
   # å‰ç«¯
   cd apps/frontend
   pnpm lint
   pnpm format:check
   pnpm test

   # åç«¯
   cd apps/backend
   flake8 .
   black --check .
   python manage.py test
   ```

3. **æäº¤ä»£ç **
   ```bash
   git add .
   git commit -m "feat: your feature description"
   git push origin feature/your-feature-name
   ```

4. **åˆ›å»º Pull Request**
   - CI å·¥ä½œæµä¼šè‡ªåŠ¨è¿è¡Œ
   - è¦†ç›–ç‡æŠ¥å‘Šä¼šè‡ªåŠ¨è¯„è®ºåˆ° PR
   - å®‰å…¨æ‰«æä¼šåœ¨åå°æ‰§è¡Œ

5. **åˆå¹¶åˆ°ä¸»åˆ†æ”¯**
   - åˆå¹¶åä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²å·¥ä½œæµ
   - å‰ç«¯éƒ¨ç½²åˆ° Vercelï¼Œåç«¯éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨

### æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

åœ¨ GitHub ä»“åº“é¡µé¢ï¼š
1. ç‚¹å‡» "Actions" æ ‡ç­¾
2. é€‰æ‹© "Deploy" å·¥ä½œæµ
3. ç‚¹å‡» "Run workflow" æŒ‰é’®
4. é€‰æ‹©è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ mainï¼‰
5. ç‚¹å‡» "Run workflow"

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### 1. æµ‹è¯•å¤±è´¥

**ç—‡çŠ¶**: CI å·¥ä½œæµåœ¨æµ‹è¯•æ­¥éª¤å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# æœ¬åœ°è¿è¡Œæµ‹è¯•
cd apps/frontend
pnpm test

cd apps/backend
python manage.py test
```

**å¸¸è§åŸå› **:
- æµ‹è¯•ä»£ç è¿‡æ—¶
- ä¾èµ–ç‰ˆæœ¬ä¸å…¼å®¹
- ç¯å¢ƒå˜é‡ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**:
- æ›´æ–°æµ‹è¯•ä»£ç 
- æ£€æŸ¥ `package.json` å’Œ `requirements.txt`
- ç¡®è®¤æµ‹è¯•ç¯å¢ƒé…ç½®æ­£ç¡®

#### 2. ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶**: ESLint æˆ– Prettier æ£€æŸ¥å¤±è´¥

**ä¿®å¤æ–¹æ³•**:
```bash
# å‰ç«¯æ ¼å¼ä¿®å¤
cd apps/frontend
pnpm lint --fix
pnpm format

# åç«¯æ ¼å¼ä¿®å¤
cd apps/backend
black .
```

#### 3. ä»£ç è¦†ç›–ç‡ä¸è¾¾æ ‡

**ç—‡çŠ¶**: è¦†ç›–ç‡ä½äº 80% é˜ˆå€¼

**æ’æŸ¥æ­¥éª¤**:
```bash
# æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
cd apps/frontend
pnpm test -- --coverage

cd apps/backend
coverage run --source='.' manage.py test
coverage report --show-missing
```

**è§£å†³æ–¹æ¡ˆ**:
- ä¸ºæœªè¦†ç›–çš„ä»£ç æ·»åŠ æµ‹è¯•
- ç§»é™¤ä¸å¿…è¦çš„ä»£ç 
- åœ¨è¦†ç›–ç‡é…ç½®ä¸­æ’é™¤æµ‹è¯•æ–‡ä»¶

#### 4. éƒ¨ç½²å¤±è´¥

**ç—‡çŠ¶**: éƒ¨ç½²å·¥ä½œæµå¤±è´¥

**è¯Šæ–­æ­¥éª¤**:

1. **æ£€æŸ¥ GitHub Secrets**
   - `VERCEL_TOKEN`
   - `SSH_PRIVATE_KEY`
   - `SSH_HOST`
   - `SSH_USERNAME`
   - `SSH_PORT`
   - `BACKEND_DEPLOY_PATH`

2. **æ£€æŸ¥æœåŠ¡å™¨è¿æ¥**
   ```bash
   ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST
   ```

3. **æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—**
   ```bash
   ssh server "tail -50 /var/log/pagemaker-deploy.log"
   ```

**å¸¸è§è§£å†³æ–¹æ¡ˆ**:
- æ›´æ–°è¿‡æœŸçš„ SSH å¯†é’¥
- æ£€æŸ¥æœåŠ¡å™¨ç£ç›˜ç©ºé—´
- éªŒè¯æ•°æ®åº“è¿æ¥
- é‡å¯ç›¸å…³æœåŠ¡

#### 5. Vercel éƒ¨ç½²é—®é¢˜

**ç—‡çŠ¶**: å‰ç«¯éƒ¨ç½²åˆ° Vercel å¤±è´¥

**æ’æŸ¥æ–¹æ³•**:
1. æ£€æŸ¥ Vercel Token æ˜¯å¦æœ‰æ•ˆ
2. ç¡®è®¤é¡¹ç›® ID å’Œ Org ID æ­£ç¡®
3. æ£€æŸ¥æ„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

**è§£å†³æ­¥éª¤**:
```bash
# æœ¬åœ°æµ‹è¯•æ„å»º
cd apps/frontend
pnpm build
```

#### 6. é‡å¤éƒ¨ç½²é—®é¢˜

**ç—‡çŠ¶**: å‰ç«¯è¢«éƒ¨ç½²äº†ä¸¤æ¬¡ï¼ˆVercel è‡ªåŠ¨éƒ¨ç½² + GitHub Actionsï¼‰

**åŸå› **: Vercel è‡ªåŠ¨éƒ¨ç½²å’Œ GitHub Actions åŒæ—¶è§¦å‘

**è§£å†³æ–¹æ¡ˆ**:
1. **æ¨è**: ç¦ç”¨ Vercel è‡ªåŠ¨éƒ¨ç½²ï¼Œä»…ä½¿ç”¨ GitHub Actions
   - è¿›å…¥ Vercel Dashboard â†’ é¡¹ç›®è®¾ç½® â†’ Git
   - å–æ¶ˆå‹¾é€‰ "Automatic deployments from Git"
   
2. **å¤‡é€‰**: ç¦ç”¨ GitHub Actions å‰ç«¯éƒ¨ç½²
   - æ³¨é‡Šæ‰ `.github/workflows/deploy.yml` ä¸­çš„ `deploy-frontend` ä½œä¸š

**è¯¦ç»†é…ç½®**: å‚è€ƒ [Vercel é›†æˆé…ç½®æŒ‡å—](vercel-integration-guide.md)

#### 6. GitHub Secrets é…ç½®é”™è¯¯

**ç—‡çŠ¶**: å·¥ä½œæµä¸­å‡ºç°è®¤è¯é”™è¯¯

**è¯Šæ–­æ–¹æ³•**:
1. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ£€æŸ¥ Secrets
2. ç¡®è®¤ Secret åç§°æ‹¼å†™æ­£ç¡®
3. éªŒè¯ Secret å€¼çš„æœ‰æ•ˆæ€§

**é…ç½®æ­¥éª¤**:
1. è¿›å…¥ GitHub ä»“åº“ â†’ Settings â†’ Secrets and variables â†’ Actions
2. ç‚¹å‡» "New repository secret"
3. æ·»åŠ æ‰€éœ€çš„ Secret

### ç´§æ€¥æƒ…å†µå¤„ç†

#### ç´§æ€¥åœç”¨ CI/CD

å¦‚æœéœ€è¦ç´§æ€¥åœç”¨æ‰€æœ‰å·¥ä½œæµï¼š

1. **ä¸´æ—¶ç¦ç”¨**:
   - è¿›å…¥ GitHub ä»“åº“ â†’ Actions
   - ç‚¹å‡»å·¥ä½œæµåç§°
   - ç‚¹å‡»å³ä¸Šè§’çš„ "..." â†’ "Disable workflow"

2. **æ°¸ä¹…ç¦ç”¨**:
   ```bash
   # é‡å‘½åå·¥ä½œæµæ–‡ä»¶
   git mv .github/workflows/ci.yml .github/workflows/ci.yml.disabled
   ```

#### ç´§æ€¥å›æ»š

**è‡ªåŠ¨å›æ»š**: éƒ¨ç½²å¤±è´¥æ—¶ä¼šè‡ªåŠ¨è§¦å‘å›æ»š

**æ‰‹åŠ¨å›æ»š**:
```bash
# SSH åˆ°æœåŠ¡å™¨
ssh server

# è¿è¡Œå›æ»šè„šæœ¬
cd /root/dev/pagemaker
source deploy-backend.sh
rollback
```

#### æ‰‹åŠ¨éƒ¨ç½²å¤‡ç”¨æ–¹æ¡ˆ

å¦‚æœ CI/CD å®Œå…¨ä¸å¯ç”¨ï¼š

**å‰ç«¯æ‰‹åŠ¨éƒ¨ç½²**:
```bash
cd apps/frontend
pnpm build
# æ‰‹åŠ¨ä¸Šä¼ åˆ° Vercel æˆ–å…¶ä»–æ‰˜ç®¡æœåŠ¡
```

**åç«¯æ‰‹åŠ¨éƒ¨ç½²**:
```bash
# SSH åˆ°æœåŠ¡å™¨
ssh server
cd /root/dev/pagemaker
git pull origin main
cd apps/backend
source venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
sudo systemctl restart pagemaker-gunicorn
```

## å·¥ä½œæµç›‘æ§

### çŠ¶æ€å¾½ç« 

åœ¨ README.md ä¸­æ·»åŠ çŠ¶æ€å¾½ç« æ¥ç›‘æ§å·¥ä½œæµçŠ¶æ€ï¼š

```markdown
![CI](https://github.com/your-org/pagemaker/workflows/CI/badge.svg)
![Security](https://github.com/your-org/pagemaker/workflows/Security%20Scan/badge.svg)
![Deploy](https://github.com/your-org/pagemaker/workflows/Deploy/badge.svg)
```

### æ—¥å¿—åˆ†æ

**æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—**:
1. è¿›å…¥ GitHub ä»“åº“ â†’ Actions
2. ç‚¹å‡»å…·ä½“çš„å·¥ä½œæµè¿è¡Œ
3. å±•å¼€å„ä¸ªæ­¥éª¤æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**ä¸‹è½½æ—¥å¿—**:
1. åœ¨å·¥ä½œæµè¿è¡Œé¡µé¢
2. ç‚¹å‡»å³ä¸Šè§’çš„é½¿è½®å›¾æ ‡
3. é€‰æ‹© "Download logs"

### æ€§èƒ½ç›‘æ§

**å·¥ä½œæµæ‰§è¡Œæ—¶é—´ä¼˜åŒ–**:
- ä½¿ç”¨ç¼“å­˜å‡å°‘ä¾èµ–å®‰è£…æ—¶é—´
- å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„ä»»åŠ¡
- ä¼˜åŒ–æµ‹è¯•å¥—ä»¶æ‰§è¡Œé€Ÿåº¦

**èµ„æºä½¿ç”¨ç›‘æ§**:
- å…³æ³¨ GitHub Actions ä½¿ç”¨é…é¢
- ç›‘æ§å·¥ä½œæµæ‰§è¡Œé¢‘ç‡
- ä¼˜åŒ–ä¸å¿…è¦çš„å·¥ä½œæµè§¦å‘

## æœ€ä½³å®è·µ

### å¼€å‘æœ€ä½³å®è·µ

1. **æäº¤å‰æœ¬åœ°éªŒè¯**
   ```bash
   # è¿è¡Œå®Œæ•´çš„æœ¬åœ°æ£€æŸ¥
   pnpm run ci:check  # å¦‚æœé…ç½®äº†æ­¤è„šæœ¬
   ```

2. **å°æ­¥éª¤æäº¤**
   - é¿å…å¤§å‹ PR å¯¼è‡´çš„å¤æ‚å†²çª
   - æ¯ä¸ªæäº¤éƒ½åº”è¯¥æ˜¯å¯å·¥ä½œçš„çŠ¶æ€

3. **æµ‹è¯•å…ˆè¡Œ**
   - æ–°åŠŸèƒ½å¿…é¡»åŒ…å«æµ‹è¯•
   - ä¿®å¤ bug æ—¶æ·»åŠ å›å½’æµ‹è¯•

### CI/CD ç»´æŠ¤

1. **å®šæœŸæ›´æ–°ä¾èµ–**
   ```bash
   # æ›´æ–° GitHub Actions
   # æ£€æŸ¥ .github/workflows/ ä¸­çš„ action ç‰ˆæœ¬
   ```

2. **ç›‘æ§å®‰å…¨æ‰«æç»“æœ**
   - åŠæ—¶å¤„ç†å‘ç°çš„å®‰å…¨æ¼æ´
   - å®šæœŸå®¡æŸ¥ä¾èµ–è®¸å¯è¯

3. **å¤‡ä»½å…³é”®é…ç½®**
   - GitHub Secrets çš„å¤‡ä»½è®°å½•
   - éƒ¨ç½²è„šæœ¬çš„ç‰ˆæœ¬æ§åˆ¶

## å®‰å…¨é…ç½®

### GitHub Secrets ç®¡ç†

æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Tokenã€SSH å¯†é’¥ç­‰ï¼‰éƒ½å¿…é¡»é€šè¿‡ GitHub Secrets è¿›è¡Œç®¡ç†ã€‚è¯¦ç»†çš„å®‰å…¨é…ç½®æŒ‡å—è¯·å‚è€ƒï¼š

ğŸ“– **[GitHub Secrets é…ç½®æŒ‡å—](github-secrets-setup.md)**

### å®‰å…¨æ£€æŸ¥æ¸…å•

åœ¨è®¾ç½® CI/CD ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] æ‰€æœ‰ GitHub Secrets å·²æ­£ç¡®é…ç½®
- [ ] æ²¡æœ‰åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ä»»ä½•æ•æ„Ÿä¿¡æ¯
- [ ] SSH å¯†é’¥æƒé™è®¾ç½®æ­£ç¡®ï¼ˆ600ï¼‰
- [ ] API Token æƒé™æœ€å°åŒ–
- [ ] å®šæœŸè½®æ¢å¯†é’¥å’Œä»¤ç‰Œ

## è”ç³»å’Œæ”¯æŒ

å¦‚æœé‡åˆ°æœ¬æ–‡æ¡£æœªè¦†ç›–çš„é—®é¢˜ï¼š

1. **æŸ¥çœ‹ GitHub Issues**: æœç´¢ç›¸å…³é—®é¢˜
2. **åˆ›å»ºæ–° Issue**: è¯¦ç»†æè¿°é—®é¢˜å’Œé‡ç°æ­¥éª¤
3. **è”ç³»å›¢é˜Ÿ**: é€šè¿‡é¡¹ç›®æ²Ÿé€šæ¸ é“å¯»æ±‚å¸®åŠ©

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-12-19  
**ç»´æŠ¤è€…**: Pagemaker å¼€å‘å›¢é˜Ÿ 