name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ

jobs:
  # CodeQL å®‰å…¨åˆ†æ
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'python' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality

    - name: Install pnpm for JavaScript analysis
      if: matrix.language == 'javascript'
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Setup Node.js for JavaScript analysis
      if: matrix.language == 'javascript'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'

    - name: Install JavaScript dependencies
      if: matrix.language == 'javascript'
      run: pnpm install --frozen-lockfile

    - name: Setup Python for Python analysis
      if: matrix.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'apps/backend/requirements.txt'

    - name: Install Python dependencies
      if: matrix.language == 'python'
      run: |
        cd apps/backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"

  # å‰ç«¯ä¾èµ–å®‰å…¨æ‰«æ
  frontend-security:
    name: Frontend Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run npm audit
      run: |
        pnpm audit --audit-level=moderate --json > audit-report.json || true
        VULNERABILITIES=$(jq '.vulnerabilities | length' audit-report.json)
        echo "å‘ç° $VULNERABILITIES ä¸ªå®‰å…¨æ¼æ´"
        
        if [ "$VULNERABILITIES" -gt 0 ]; then
          echo "ğŸ”´ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯¦æƒ…ï¼š"
          pnpm audit --audit-level=moderate
          echo "è¯·è¿è¡Œ 'pnpm audit --fix' ä¿®å¤å¯è‡ªåŠ¨ä¿®å¤çš„æ¼æ´"
          exit 1
        else
          echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´"
        fi

    - name: Upload audit report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-audit-report
        path: apps/frontend/audit-report.json

  # åç«¯ä¾èµ–å®‰å…¨æ‰«æ
  backend-security:
    name: Backend Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'apps/backend/requirements.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit

    - name: Run Safety check
      run: |
        safety check --json > safety-report.json || true
        VULNERABILITIES=$(jq '. | length' safety-report.json)
        echo "å‘ç° $VULNERABILITIES ä¸ªå·²çŸ¥å®‰å…¨æ¼æ´"
        
        if [ "$VULNERABILITIES" -gt 0 ]; then
          echo "ğŸ”´ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯¦æƒ…ï¼š"
          safety check
          exit 1
        else
          echo "âœ… æœªå‘ç°å·²çŸ¥å®‰å…¨æ¼æ´"
        fi

    - name: Run Bandit security linter
      run: |
        bandit -r . -f json -o bandit-report.json || true
        ISSUES=$(jq '.results | length' bandit-report.json)
        echo "å‘ç° $ISSUES ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜"
        
        if [ "$ISSUES" -gt 0 ]; then
          echo "ğŸŸ¡ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜ï¼Œè¯¦æƒ…ï¼š"
          bandit -r . -f txt
          echo "è¯·å®¡æŸ¥ä¸Šè¿°é—®é¢˜å¹¶é…Œæƒ…ä¿®å¤"
          # Bandit issues ä¸é˜»æ–­å·¥ä½œæµï¼Œåªæ˜¯è­¦å‘Š
        else
          echo "âœ… æœªå‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜"
        fi

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-security-reports
        path: |
          apps/backend/safety-report.json
          apps/backend/bandit-report.json

  # ä¾èµ–è®¸å¯è¯æ£€æŸ¥
  license-check:
    name: License Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Check licenses
      run: |
        npx license-checker --summary --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD' --excludePrivatePackages > license-report.txt || true
        
        if [ -s license-report.txt ]; then
          echo "âœ… æ‰€æœ‰ä¾èµ–çš„è®¸å¯è¯éƒ½ç¬¦åˆè¦æ±‚"
          cat license-report.txt
        else
          echo "ğŸ”´ å‘ç°ä¸ç¬¦åˆè¦æ±‚çš„è®¸å¯è¯"
          npx license-checker --summary
          exit 1
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v4
      with:
        name: license-report
        path: license-report.txt 