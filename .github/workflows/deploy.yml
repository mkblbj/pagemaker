name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  pull-requests: write
  issues: write
  repository-projects: read

jobs:
  # å‰ç«¯éƒ¨ç½²åˆ°Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.set-deployment-url.outputs.deployment_url }}
    defaults:
      run:
        working-directory: apps/frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Vercel secrets
      run: |
        echo "ğŸ” éªŒè¯ Vercel éƒ¨ç½² secrets..."
        
        # æ£€æŸ¥å¿…è¦çš„ Vercel secrets æ˜¯å¦å­˜åœ¨
        MISSING_SECRETS=()
        
        if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
          MISSING_SECRETS+=("VERCEL_TOKEN")
        fi
        
        if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
          MISSING_SECRETS+=("VERCEL_ORG_ID")
        fi
        
        if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
          MISSING_SECRETS+=("VERCEL_PROJECT_ID")
        fi
        
        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦çš„ Vercel Secrets:"
          printf '%s\n' "${MISSING_SECRETS[@]}"
          echo ""
          echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®è¿™äº› secretsã€‚"
          echo "è¯¦ç»†é…ç½®æŒ‡å—: docs/github-secrets-setup.md"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰ Vercel secrets å·²é…ç½®"
      
    - name: Install pnpm
      uses: pnpm/action-setup@v4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'
        
    - name: Install dependencies (root level)
      run: cd ../.. && pnpm install --frozen-lockfile
      
    - name: Build shared-types package
      run: cd ../../packages/shared-types && pnpm build
      
    - name: Build frontend
      run: pnpm build
      
    - name: Deploy to Vercel
      id: vercel-deploy
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod --env VERCEL_FUNCTIONS_MAX_DURATION=30'
        # å¼ºåˆ¶éƒ¨ç½²ï¼Œé¿å…ä¸ Vercel è‡ªåŠ¨éƒ¨ç½²å†²çª
        github-comment: false
        
    - name: Set deployment URL output
      id: set-deployment-url
      run: |
        # è·å– Vercel éƒ¨ç½² URL
        DEPLOYMENT_URL="${{ steps.vercel-deploy.outputs.preview-url }}"
        
        if [ -n "$DEPLOYMENT_URL" ]; then
          echo "ğŸš€ å‰ç«¯å·²éƒ¨ç½²åˆ° Vercel: $DEPLOYMENT_URL"
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ æœªèƒ½è·å–åˆ° Vercel éƒ¨ç½² URL"
          echo "è¯·æ£€æŸ¥ Vercel éƒ¨ç½²æ­¥éª¤æ˜¯å¦æˆåŠŸ"
          echo "deployment_url=unknown" >> $GITHUB_OUTPUT
        fi

  # åç«¯éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
  deploy-backend:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest
    needs: deploy-frontend  # ç­‰å¾…å‰ç«¯éƒ¨ç½²å®Œæˆ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run pre-deploy checks
      run: |
        chmod +x scripts/pre-deploy-check.sh
        ./scripts/pre-deploy-check.sh
      
    - name: Validate required secrets
      run: |
        echo "ğŸ” éªŒè¯å¿…è¦çš„éƒ¨ç½² secrets..."
        
        # æ£€æŸ¥å¿…è¦çš„ secrets æ˜¯å¦å­˜åœ¨
        MISSING_SECRETS=()
        
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          MISSING_SECRETS+=("SSH_PRIVATE_KEY")
        fi
        
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          MISSING_SECRETS+=("SSH_HOST")
        fi
        
        if [ -z "${{ secrets.SSH_USERNAME }}" ]; then
          MISSING_SECRETS+=("SSH_USERNAME")
        fi
        
        if [ -z "${{ secrets.SSH_PORT }}" ]; then
          MISSING_SECRETS+=("SSH_PORT")
        fi
        
        if [ -z "${{ secrets.BACKEND_DEPLOY_PATH }}" ]; then
          MISSING_SECRETS+=("BACKEND_DEPLOY_PATH")
        fi
        
        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦çš„ GitHub Secrets:"
          printf '%s\n' "${MISSING_SECRETS[@]}"
          echo ""
          echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®è¿™äº› secretsã€‚"
          echo "è¯¦ç»†é…ç½®æŒ‡å—: docs/github-secrets-setup.md"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰å¿…è¦çš„ secrets å·²é…ç½®"
      
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Execute deployment script
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.BACKEND_DEPLOY_PATH }} && ./scripts/deploy-backend.sh"
        
    - name: Verify deployment
      run: |
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
        HEALTH_CHECK=$(ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "curl -f -s http://localhost:8456/api/v1/health/ || echo 'FAILED'")
        
        if [[ "$HEALTH_CHECK" == "FAILED" ]]; then
          echo "âŒ åç«¯éƒ¨ç½²éªŒè¯å¤±è´¥"
          exit 1
        else
          echo "âœ… åç«¯éƒ¨ç½²éªŒè¯æˆåŠŸ"
        fi
        
    - name: Get deployment logs
      if: always()
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "tail -50 /var/log/pagemaker-deploy.log" || echo "æ— æ³•è·å–éƒ¨ç½²æ—¥å¿—"
        
    - name: Notify deployment result
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸ"
        else
          echo "âŒ åç«¯éƒ¨ç½²å¤±è´¥"
        fi
        
        echo "**éƒ¨ç½²è¯¦æƒ…:**"
        echo "- æäº¤: ${{ github.sha }}"
        echo "- åˆ†æ”¯: ${{ github.ref_name }}"
        echo "- æ—¶é—´: $(date)"

  # éƒ¨ç½²åé›†æˆæµ‹è¯•
  post-deploy-tests:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always() && needs.deploy-backend.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Run smoke tests
      run: |
        # å‰ç«¯å¥åº·æ£€æŸ¥
        echo "æ£€æŸ¥å‰ç«¯éƒ¨ç½²..."
        FRONTEND_URL="${{ needs.deploy-frontend.outputs.deployment_url }}"
        if [ "$FRONTEND_URL" != "unknown" ] && [ -n "$FRONTEND_URL" ]; then
          curl -f "$FRONTEND_URL" || echo "å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥: $FRONTEND_URL"
        else
          echo "âš ï¸ è·³è¿‡å‰ç«¯å¥åº·æ£€æŸ¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆçš„éƒ¨ç½² URL"
        fi
        
        # åç«¯å¥åº·æ£€æŸ¥
        echo "æ£€æŸ¥åç«¯éƒ¨ç½²..."
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "curl -f http://localhost:8456/api/v1/health/" || echo "åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
        
    - name: Run basic API tests
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ åŸºç¡€çš„APIæµ‹è¯•
        echo "APIæµ‹è¯•å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"
        
  # éƒ¨ç½²å¤±è´¥æ—¶çš„ç´§æ€¥å›æ»š
  emergency-rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: failure() && needs.deploy-backend.result == 'failure'
    
    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Execute emergency rollback
      run: |
        echo "æ‰§è¡Œç´§æ€¥å›æ»š..."
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "
          cd ${{ secrets.BACKEND_DEPLOY_PATH }} && 
          if [ -f scripts/deploy-backend.sh ]; then
            source scripts/deploy-backend.sh
            rollback
          else
            echo 'éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨ï¼Œæ— æ³•è‡ªåŠ¨å›æ»š'
            echo 'è¯·æ‰‹åŠ¨æ£€æŸ¥ /root/backups/pagemaker/ ä¸­çš„å¤‡ä»½æ–‡ä»¶'
            exit 1
          fi
        "
        
    - name: Notify rollback
      run: |
        echo "ğŸ”„ ç´§æ€¥å›æ»šå·²æ‰§è¡Œ"
        echo ""
        echo "ç”±äºéƒ¨ç½²å¤±è´¥ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚"
        echo ""
        echo "**å›æ»šè¯¦æƒ…:**"
        echo "- å¤±è´¥æäº¤: ${{ github.sha }}"
        echo "- å›æ»šæ—¶é—´: $(date)"
        echo ""
        echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜åé‡æ–°éƒ¨ç½²ã€‚" 